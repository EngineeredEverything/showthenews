<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShowTheNews Analytics Dashboard</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #030712 0%, #1a1f3a 100%);
      color: white;
      min-height: 100vh;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.3s;
    }
    .stat-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(96, 165, 250, 0.5);
      transform: translateY(-2px);
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #60a5fa, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .event-bar {
      background: linear-gradient(90deg, rgba(96, 165, 250, 0.8) 0%, rgba(96, 165, 250, 0.3) 100%);
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    .event-bar:hover {
      background: linear-gradient(90deg, rgba(96, 165, 250, 1) 0%, rgba(96, 165, 250, 0.4) 100%);
      transform: translateX(4px);
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-6 py-8 max-w-6xl">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            üìä Analytics Dashboard
          </h1>
          <p class="text-gray-400 mt-2">Real-time engagement metrics ‚Ä¢ <span id="timestamp">Loading...</span></p>
        </div>
        <a href="./index.html" class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg border border-blue-500/30 hover:bg-blue-500/30 transition-all">
          ‚Üê Back to News
        </a>
      </div>
    </div>

    <!-- System Health -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-300">System Health</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Status</div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-xl font-semibold text-green-400" id="status">Healthy</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Uptime</div>
          <div class="stat-number" id="uptime">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Stories</div>
          <div class="stat-number" id="totalStories">‚Äî</div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Events</div>
          <div class="stat-number" id="totalEvents">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Engagement Metrics -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-300">Engagement Metrics</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Total Requests</div>
          <div class="stat-number" id="totalRequests">‚Äî</div>
          <div class="text-xs text-gray-500 mt-2">API calls since <span id="trackingSince">‚Äî</span></div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Unique Visitors</div>
          <div class="stat-number" id="uniqueVisitors">‚Äî</div>
          <div class="text-xs text-gray-500 mt-2">Distinct IP addresses</div>
        </div>
        <div class="stat-card">
          <div class="text-gray-400 text-sm mb-2">Total Clicks</div>
          <div class="stat-number" id="totalClicks">‚Äî</div>
          <div class="text-xs text-gray-500 mt-2">Story engagement events</div>
        </div>
      </div>
    </div>

    <!-- Top Events -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-300">Most Engaged Stories</h2>
      <div class="stat-card">
        <div id="topEvents">
          <div class="text-center text-gray-500 py-8">Loading engagement data...</div>
        </div>
      </div>
    </div>

    <!-- Active Sources -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-300">Active News Sources</h2>
      <div class="stat-card">
        <div id="activeSources" class="flex flex-wrap gap-2">
          <div class="text-gray-500">Loading sources...</div>
        </div>
      </div>
    </div>

    <!-- Last Update -->
    <div class="text-center text-gray-600 text-sm">
      Last refreshed: <span id="lastRefresh">‚Äî</span>
      <button onclick="loadAnalytics()" class="ml-4 text-blue-400 hover:text-blue-300 underline">
        Refresh Now
      </button>
    </div>
  </div>

  <script>
    async function loadAnalytics() {
      try {
        // Fetch health data
        const healthResponse = await fetch('./api/health');
        const health = await healthResponse.json();
        
        // Fetch analytics data
        const analyticsResponse = await fetch('./api/analytics');
        const analytics = await analyticsResponse.json();
        
        // Fetch news data for sources
        const newsResponse = await fetch('./api/news');
        const news = await newsResponse.json();
        
        // Update system health
        document.getElementById('status').textContent = health.status === 'healthy' ? 'Healthy' : 'Error';
        document.getElementById('uptime').textContent = formatUptime(health.uptime);
        document.getElementById('totalStories').textContent = health.totalStories;
        document.getElementById('totalEvents').textContent = health.totalEvents;
        
        // Update engagement metrics
        document.getElementById('totalRequests').textContent = analytics.totalRequests.toLocaleString();
        document.getElementById('uniqueVisitors').textContent = analytics.uniqueVisitors.toLocaleString();
        
        const totalClickCount = analytics.topEvents.reduce((sum, [title, count]) => sum + count, 0);
        document.getElementById('totalClicks').textContent = totalClickCount.toLocaleString();
        
        document.getElementById('trackingSince').textContent = 
          new Date(analytics.since).toLocaleDateString() + ' ' + 
          new Date(analytics.since).toLocaleTimeString();
        
        // Update top events
        const topEventsHtml = analytics.topEvents.length > 0 
          ? analytics.topEvents.map(([title, count]) => {
              const maxClicks = analytics.topEvents[0][1];
              const width = (count / maxClicks) * 100;
              return `
                <div class="event-bar" style="width: ${width}%;">
                  <span class="flex-1 text-sm truncate">${title}</span>
                  <span class="text-sm font-semibold ml-2">${count} click${count > 1 ? 's' : ''}</span>
                </div>
              `;
            }).join('')
          : '<div class="text-center text-gray-500 py-4">No engagement data yet</div>';
        
        document.getElementById('topEvents').innerHTML = topEventsHtml;
        
        // Update active sources
        const sourcesHtml = news.sources.map(source => 
          `<span class="px-3 py-1.5 bg-blue-500/10 text-blue-400 rounded-full text-sm border border-blue-500/20">${source}</span>`
        ).join('');
        
        document.getElementById('activeSources').innerHTML = sourcesHtml;
        
        // Update timestamps
        document.getElementById('timestamp').textContent = 
          'Updated ' + new Date().toLocaleTimeString();
        document.getElementById('lastRefresh').textContent = 
          new Date().toLocaleTimeString();
        
      } catch (err) {
        console.error('Error loading analytics:', err);
        document.getElementById('topEvents').innerHTML = 
          '<div class="text-center text-red-400 py-8">Error loading analytics</div>';
      }
    }
    
    function formatUptime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      
      if (hours > 24) {
        const days = Math.floor(hours / 24);
        return `${days}d ${hours % 24}h`;
      } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else {
        return `${minutes}m`;
      }
    }
    
    // Load on page load
    loadAnalytics();
    
    // Auto-refresh every 30 seconds
    setInterval(loadAnalytics, 30 * 1000);
  </script>
</body>
</html>
